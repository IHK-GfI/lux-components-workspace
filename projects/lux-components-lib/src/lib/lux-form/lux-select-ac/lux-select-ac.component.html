@if (formGroup) {
  <lux-form-control-wrapper
    (click)="onWrapperClick()"
    [luxFormComponent]="this"
    [formGroup]="formGroup"
    [luxNoLabels]="luxNoLabels"
    [luxNoBottomLabel]="luxNoBottomLabel"
    [luxNoTopLabel]="luxNoTopLabel"
    [luxLabelLongFormat]="luxLabelLongFormat"
    [ngClass]="matSelect && matSelect.panelOpen ? 'lux-panel-opened' : ''"
    luxTagId="luxSelectWrapper"
  >
    <!--
    Material-Workaround: Incorrect use of <label for=FORM_ELEMENT> (Browser-Fehler in der Debug-Console)
    ------------------------------------------------------------------------------------------------------------------
    Das mat-select nutzt intern kein echtes HTML-Element wie das select und darum wird der obige Fehler geworfen.
    Die aktuelle Lösung ist ein zusätzliches Select einzufügen und zu verstecken, damit der Fehler verschwindet.
    Wenn der Fehler in den Material Components behoben wurde, dann kann das unsichtbare Select wieder entfernt werden.
    -->
    <select [id]="uid" style="display: none"></select>
    <mat-select
      luxTagIdHandler
      [luxTagId]="luxTagId"
      [luxSelectFilter]="luxEnableFilter"
      [luxFilterLabelFn]="filterLabelFn"
      [placeholder]="luxPlaceholder"
      [multiple]="luxMultiple"
      [compareWith]="compareObjects"
      [required]="luxRequired"
      [disableRipple]="true"
      [formControl]="formControl"
      [attr.aria-invalid]="formControl.invalid"
      [attr.aria-required]="luxRequired"
      [attr.aria-readonly]="luxReadonly"
      [id]="uid"
      [panelClass]="[
        luxMultiple ? 'lux-select-panel-ac-multiple' : 'lux-select-panel-ac',
        luxReadonly ? 'lux-display-none' : '',
        luxEnableFilter ? 'lux-select-panel-ac-filter' : ''
      ]"
      [luxAriaLabelledby]="uid + '-label'"
      [luxAriaDescribedby]="describedBy()"
      (focusin)="onFocusIn($event)"
      (focusout)="onFocusOut($event)"
      (openedChange)="onOpenedChange($event, selectFilter)"
      #selectFilter="luxSelectFilter"
      #select
    >
      @if (luxEnableFilter) {
        <lux-select-panel-filter
          [placeholder]="luxFilterPlaceholder"
          [filterValue]="luxFilterValue"
          [clearAriaLabel]="luxFilterClearAriaLabel"
          [filterDirective]="selectFilter"
        ></lux-select-panel-filter>
      }
      @for (i of renderOptionIndexes; track i) {
        <mat-option
          [value]="luxPickValue ? _luxOptionsPickValue[i] : luxOptions[i]"
          class="option-height"
          [style.display]="!luxEnableFilter || selectFilter.isIndexVisible(i) ? '' : 'none'"
        >
          <ng-container
            *ngTemplateOutlet="tempRef && !luxOptionLabelProp ? tempRef : noTemplateRefTemplate; context: { $implicit: luxOptions[i] }"
          ></ng-container>
        </mat-option>
      }
    </mat-select>
  </lux-form-control-wrapper>
}

<ng-template #noTemplateRefTemplate let-option>
  @if (option && luxOptionLabelProp && option[luxOptionLabelProp]) {
    {{ option | luxRenderProperty: luxOptionLabelProp }}
  } @else {
    @if (!!option) {
      {{ option }}
    }
  }
</ng-template>
